version: '3.8'

# RonDB-Docker version: 0.2-SNAPSHOT
services:

    mgmd_1:
      image: rondb-standalone:21.04.9
      container_name: mgmd_1
      command: ["ndb_mgmd", "--ndb-nodeid=65", "--initial"]
      deploy:
        resources:
          limits:
            cpus: '0.2'
            memory: 50M
          reservations:
            memory: 20M
      volumes:
      - <path-to-repo>/rondb-docker/autogenerated_files/v21049_m1_g1_r2_my1_api1/config.ini:/srv/hops/mysql-cluster/config.ini
      - dataDir_mgmd_1:/srv/hops/mysql-cluster/mgmd
      - logDir_mgmd_1:/srv/hops/mysql-cluster/log

    ndbd_1:
      image: rondb-standalone:21.04.9
      container_name: ndbd_1
      command: ["ndbmtd", "--ndb-nodeid=1", "--initial", "--ndb-connectstring=mgmd_1:1186"]
      deploy:
        resources:
          limits:
            cpus: '2'
            memory: 3000M
          reservations:
            memory: 2000M
      volumes:
      - dataDir_ndbd_1:/srv/hops/mysql-cluster/ndb_data
      - logDir_ndbd_1:/srv/hops/mysql-cluster/log

    ndbd_2:
      image: rondb-standalone:21.04.9
      container_name: ndbd_2
      command: ["ndbmtd", "--ndb-nodeid=2", "--initial", "--ndb-connectstring=mgmd_1:1186"]
      deploy:
        resources:
          limits:
            cpus: '2'
            memory: 3000M
          reservations:
            memory: 2000M
      volumes:
      - dataDir_ndbd_2:/srv/hops/mysql-cluster/ndb_data
      - logDir_ndbd_2:/srv/hops/mysql-cluster/log

    mysqld_1:
      image: rondb-standalone:21.04.9
      container_name: mysqld_1
      command: ["mysqld"]
      cap_add:
        - SYS_NICE
      deploy:
        resources:
          limits:
            cpus: '2'
            memory: 1400M
          reservations:
            memory: 650M
      volumes:
      - <path-to-repo>/rondb-docker/autogenerated_files/v21049_m1_g1_r2_my1_api1/my.cnf:/srv/hops/mysql-cluster/my.cnf
      - dataDir_mysqld_1:/srv/hops/mysql-cluster/mysql
      - mysqlFilesDir_mysqld_1:/srv/hops/mysql-cluster/mysql-files
      environment:
      - MYSQL_ALLOW_EMPTY_PASSWORD=true
      - MYSQL_USER=mysql
      - MYSQL_PASSWORD=Abc123?e
      - MYSQL_SETUP_APP=1

    api_1:
      image: rondb-standalone:21.04.9
      container_name: api_1
      command: >
          bash -c "ndb_waiter --ndb-connectstring=mgmd_1:1186 &&
                    sleep 50 &&
                    bench_run.sh --verbose --default-directory /home/mysql/benchmarks/sysbench_single "
      deploy:
        resources:
          limits:
            cpus: '2'
            memory: 100M
          reservations:
            memory: 100M
      volumes:
      - <path-to-repo>/rondb-docker/autogenerated_files/v21049_m1_g1_r2_my1_api1/volumes/sysbench_single:/home/mysql/benchmarks/sysbench_single
      - <path-to-repo>/rondb-docker/autogenerated_files/v21049_m1_g1_r2_my1_api1/volumes/dbt2_single:/home/mysql/benchmarks/dbt2_single
      environment:
      - MYSQL_PASSWORD=Abc123?e

volumes:
    dataDir_mgmd_1:
    logDir_mgmd_1:
    dataDir_ndbd_1:
    logDir_ndbd_1:
    dataDir_ndbd_2:
    logDir_ndbd_2:
    dataDir_mysqld_1:
    mysqlFilesDir_mysqld_1:

